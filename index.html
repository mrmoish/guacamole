<!DOCTYPE html>
<html>
<head>
	<!-- –∫–æ–¥–∏—Ä–æ–≤–∫—É UTF-8 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤ –º–∏—Ä–∞ -->
	<meta charset='UTF-8'>
	<!-- width=device-width - —à–∏—Ä–∏–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–≤–Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞(–±–µ–∑ —ç–º–∏—Ç–∞—Ü–∏–∏)
		–ú–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —ç–º–∏—Ç–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π —ç–∫—Ä–∞–Ω (980px)
		–∏ —á—Ç–æ–±—ã –æ–Ω–∞ —É–º–µ—Å—Ç–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–º–µ–Ω—å—à–∞—é—Ç –º–∞—Å—à—Ç–∞–± —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
		–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–º–∏.
		initial-scale=1.0 
		(?)–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–∞—Å—à—Ç–∞–± —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥–µ—Ç 100% (–Ω–µ –±—É–¥–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é),
		—Ç–∞–∫ —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –∏–ª–∏ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π.-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
let lang = 'ru'

const langs = {
	ru: [
		["–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ –∏—Å–ø–∞–Ω—Å–∫–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ!",
		"–í –∏—Å–ø–∞–Ω—Å–∫–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–µ ‚Äî –≤–∫–ª—é—á–∞–π –º–∏–∫—Ä–æ—Ñ–æ–Ω!",
		"–ò—Å–ø–∞–Ω—Å–∫–∏–π —Ä—è–¥–æ–º ‚Äì –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–∞–π!",
		"–ì–æ–≤–æ—Ä—è—Ç –ø–æ-–∏—Å–ø–∞–Ω—Å–∫–∏: –≤–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω!",
		"–°–ª—ã—à–∏—à—å –∏—Å–ø–∞–Ω—Å–∫–∏–π: –≤–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"],
		'es-AR',
		'es',
		'ru',
		'ESru'],
	es: [
		["¬°Prend√© el micr√≥fono cuando escuch√°s ruso!",
		"¬°Micr√≥fono listo cuando suena ruso!",
		"¬°Escuch√°s ruso? ¬°Prend√© el micro!",
		"Si escuch√°s el idioma ruso, ¬°us√° el micr√≥fono!"],
		'ru-RU',
		'ru',
		'es',
		'RUes']
}


/*
	===================
	–°–í–ê–ô–ü - –°–ú–ï–ù–ê –Ø–ó–´–ö–ê
	===================
*/

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
    let startY;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞—á–∞–ª–∞ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
    document.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞—Å–∞–Ω–∏—è –ø–æ –æ—Å–∏ Y
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
    document.addEventListener('touchend', function(e) {

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω–µ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è –ø–æ –æ—Å–∏ Y
        let endY = e.changedTouches[0].clientY;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö (—Ä–∞–∑–Ω–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π –±–æ–ª—å—à–µ 50 –ø–∏–∫—Å–µ–ª–µ–π)
        if (startY - endY > 50 || endY - startY > 50) {

			lang = lang === 'ru' ? 'es' : 'ru'
			setHeroPhrase()
        }
    });

/*
	==================
	–†–ê–°–ü–û–ó–ù–û–í–ê–ù–ò–ï –†–ï–ß–ò
	==================
*/

function startHearing(){
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Web Speech API
	if (!('webkitSpeechRecognition' in window)) {
		alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é')
		return
	}

	document.getElementById('hello').style.display = 'none'
	recognition.start()
}

const recognition = new webkitSpeechRecognition(); //  –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
recognition.interimResults = true; // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–æ–≤–∞–Ω–∏—è


recognition.onend = () => {
    //–∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞(–Ω–µ–º–Ω–æ–≥–æ –∫–∞–ª—Ö–æ–∑)
    recognition.start();
    
};

recognition.onresult = (event) => {

for (let i = event.resultIndex; i < event.results.length; i++) {

	const text = event.results[i][0].transcript 

	if (event.results[i].isFinal) {
		// –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü p
		document.getElementById('process').insertAdjacentHTML('beforebegin', " " + text);
		document.getElementById('process').innerHTML = ''
	}
	else{
		document.getElementById('process').innerHTML = " " + text;
	}

	window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
}
};

/*
	================
	–í–´–î–ï–õ–ï–ù–ù–ò–ù–ï –§–†–ê–ó
	================
*/

const selection = window.getSelection();

let startFirst, startLast
document.addEventListener('touchmove', function(event) {
	// –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞—Å–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –ø–∞–ª–µ—Ü–≤
	const x = event.touches[0].clientX;
	const y = event.touches[0].clientY;



	// –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —É–∑–µ–ª –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º
	// üî¥ —ç–∫—Å–ø–µ—Ä–º–µ–Ω—Ç–∞–ª–Ω–∞—è —Ñ—É–∫–Ω—Ü–∏—è (–Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
	// —Ä–∞–±–∞—Ç–µ–π –≤ —Ö—Ä–æ–º–µ –∏ —Å–∞—Ñ–∞—Ä–µ
	// –Ω–µ —Ä–∞–±–æ–∞—Ç–µ—Ç –≤ —Ñ–∞–∏—Ä—Ñ–æ–∫—Å
	const range = document.caretRangeFromPoint(x, y);


	// –µ—Å–ª–∏ –Ω–µ —Ç–µ–≥ p
	if (range.startContainer.parentElement.tagName !== "P") 
		return;

	const text = range.startContainer.textContent; // –¢–µ–∫—Å—Ç —É–∑–ª–∞
	const offset = range.startOffset; // –ò–Ω–¥–µ–∫—Å –±—É–∫–≤—ã –≤ —Ç–µ–∫—Å—Ç–µ

	// –∏–Ω–¥–æ–∫—Å –±–ª–∏–∂–∞–π—à–µ–≥–æ –ø—Ä–æ–±–µ–ª–∞ —Å–ª–µ–≤–æ –æ—Ç –Ω–∞–∂–∞—Ç–∏—è
	const preStart = text.lastIndexOf(' ', offset); 
	// –µ—Å–ª–∏ –ø—Ä–æ–±–µ–ª
	// range.collapsed
	if(preStart === offset) return // –µ—Å–ª–∏ –ø—Ä–æ–±–µ–ª
	let start = preStart+1

        

	if(start === startFirst) return // –µ—Å–ª–∏ —Ç–æ–∂–µ —Å–ª–æ–≤–æ

	// –ò–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –±—É–∫–≤—ã —Å–ª–æ–≤–∞ –∏–ª–∏ -1 –µ—Å–ª–∏ –Ω–µ—Ç
	const preEnd = text.indexOf(' ', offset);
	// –µ—Å–ª–∏ -1 –æ–¥–∏–Ω —Ç–æ –∫–æ–Ω–µ—Ü —ç—Ç–æ –∫–æ–Ω—á–µ —Å—Ç—Ä–æ–∫–∏
	let end = preEnd !== -1 ?  preEnd : text.length;


        

	if(startFirst < start)// –∫–æ–≥–¥–∞ –≤—ã–¥–µ–ª—è—Ç—Å—è —Ç–µ–∫—Å—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ü–∞ 
		start = startFirst
	else if(start < startFirst) // –∫–æ–≥–¥–∞ –≤—ã–¥–µ–ª—è—Ç—Å—è —Ç–µ–∫—Å—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ 
		end = startLast
	else if(!startFirst){ // –ø–µ—Ä–≤—ã–π —Ä–∞–∑
		startFirst = start
		startLast = end
	} 
	else return
        


	range.setStart(range.startContainer, start)
	range.setEnd(range.startContainer, end)
	
	selection.removeAllRanges(); // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
	selection.addRange(range); // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω

});

document.addEventListener('touchend', function(event){
	const words = selection.getRangeAt(0).toString()
	const countWords = words.split(' ').length

	// TODO: –ï—Å–ª–∏ –µ—Å—Ç—å .!? –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å 
	if (2 <= countWords){ //&& countWords <= 4){

		const strong = document.createElement('strong')

		selection.getRangeAt(0).surroundContents(strong)

		
		translateText(words, strong)
	}

       
	selection.removeAllRanges(); // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è

	// TODO: –±–∞–≥ –ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ strong
	// TODO: —á—Ç–æ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–¥–µ–ª–∏—Ç—å strong –ø–æ–≤—Ç—Ä–æ–Ω–æ —Å –±–æ–ª—å—à–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
	startFirst = undefined
	// startLast = undefined
})

/*
	=======================
	–ü–ï–†–ï–í–û–î –í–´–î–ï–õ–ï–ù–ù–´–• –§–†–ê–ó
	=======================
*/


async function translateText(text, htmlObj) {

	const url = 'https://api-free.deepl.com/v2/translate';
	const apiKey = "6d57d47a-e332-4c47-b865-8d3e506be91e:fx"; // –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à API –∫–ª—é—á –∑–¥–µ—Å—å

	const params = new URLSearchParams();
	params.append('auth_key', apiKey);
	// —Å –∫–æ–≥–æ –∏ –Ω–∞ –∫–∞–∫–æ–π —è–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å
	params.append('source_lang', langs[lang][2]);
	params.append('target_lang', langs[lang][3]);
	params.append('text', text);


	try {
		const response = await fetch(url, {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: params
		});

		if (!response.ok) {
			alert(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`)
			throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
		}

		const data = await response.json();

		const textTrans = data.translations[0].text
	
		htmlObj.setAttribute('data-overlay', textTrans)

		const queryString = new URLSearchParams({collection: langs[lang][4], source: text, target: textTrans}).toString(); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞
		fetch('api/add?' + queryString, { method: 'GET'})
	} catch (error) {
		alert('–û—à–∏–±–∫–∞:', error);
	}
}

</script>

<style>
body{
	font-family: Tahoma, sans-serif;
	height: 100vh;

	display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flexbox –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
	align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
	justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
	text-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–º–∫–æ–≤ */

	text-align: justify;
    margin: 2em;
    line-height: 3em;

	/* –æ—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω–µ—Ä—Ü–∏—é ios –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (—Ç–∞–∫–∂–µ –∫–æ–≥–¥–∞ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∏–∂–µ –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞) */
	/* —Ç–∞–∫–∂–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∂–µ—Å—Ç—ã(—Å–≤–∞–π–ø –≤–Ω–∏–∑ - –æ–±–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–Ω–∏—Ü—ã) –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
	touch-action: none;
}

span{
    color: #ccc;
}

strong{
	position: relative;
	display:inline-block;
}
strong::before {
	content: attr(data-overlay);
	position: absolute;
	bottom: 50%;
	color: #ccc; 
	white-space: nowrap;
}

h1{
	font-weight: 100;
	margin-bottom: 2em;
}

main{
	text-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–º–∫–æ–≤ */
}
button{
	border-radius: 50%;
	padding: 2em;
	color: inherit;
	background: transparent;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
@media (prefers-color-scheme: dark) {
	body {
		background-color: black;
		color: white;
	}
}
</style>
</head>

<body>

<p><span id='process' ></span></p>

<main id="hello">
	<h1 id='hero-phrase'></h1>
	
	<button onclick='startHearing()'>
	<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width='200px'>
		<path stroke-linecap="round" stroke-linejoin="round" stroke-width="0.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
		</path>
	</svg>
<!-- 
	<svg width="200px" height="200px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		<g id="icomoon-ignore">
		</g>
		<path stroke-linecap="round" d="M16.003 22.377c3.231 0 5.851-2.619 5.851-5.851v-10.639c0-3.231-2.62-5.85-5.851-5.85s-5.851 2.619-5.851 5.85v10.639c0 3.231 2.62 5.851 5.851 5.851zM11.216 5.888c0-2.639 2.147-4.786 4.787-4.786s4.787 2.147 4.787 4.786v10.639c0 2.64-2.147 4.787-4.787 4.787s-4.787-2.147-4.787-4.787v-10.639z" fill="#000000">
		
		</path>
		<path stroke-linecap="round" d="M23.978 11.207v5.319c0 4.399-3.579 7.978-7.978 7.978s-7.978-3.579-7.978-7.978v-5.319h-1.064v5.319c0 4.83 3.81 8.776 8.581 9.018h-0.068v5.354h-4.79v1.064h10.637v-1.064h-4.784v-5.354h-0.073c4.771-0.243 8.581-4.189 8.581-9.018v-5.319h-1.064z" fill="#000000">
		
		</path>
	</svg> -->

	<!-- <svg width="50px" height="50px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
		<path d="M24 0L0 24" stroke="#333333" stroke-width="2" stroke-linecap="round"/>
		<path d="M0 0L24 24" stroke="#333333" stroke-width="2" stroke-linecap="round"/>
		</svg>
	</button> -->

<script>

/*
	====================================
	–°–õ–£–ß–ê–ô–ù–´–ô –í–´–ë–û–† –ü–†–ò–í–ï–¢–°–¢–í–ï–ù–ù–û–ô –§–†–ê–ó–´
	====================================
*/

setHeroPhrase()
function setHeroPhrase(){


	recognition.lang = langs[lang][1]; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫–∞ –∏ —Ä–µ–≥–∏–æ–Ω–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–æ–≤–∞–Ω–∏—è —Ä–µ—á–∏

	// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
	const randomIndex = Math.floor(Math.random() * langs[lang][0].length)

	// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–π —Ñ—Ä–∞–∑—ã –≤ —ç–ª–µ–º–µ–Ω—Ç —Å id="main-phrase"
	document.getElementById('hero-phrase').textContent = langs[lang][0][randomIndex]



}
</script>
</main>
</body>
</html>
